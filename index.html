<!DOCTYPE html>
<html lang="ar" dir="rtl" manifest="cache.manifest">
<head>
    <meta charset="UTF-8">
    <title>Malta Pro - Fixed Stable</title>
    <script type="module" src="psfree.mjs"></script>
    <script type="module" src="lapse.mjs"></script>
    <script type="module" src="config.mjs"></script>
    <script type="module" src="alert.mjs"></script>
    <script type="module" src="send.mjs"></script>

    <style>
        @font-face { font-family: 'Orbitron'; src: url('orbitron.woff2') format('woff2'); font-weight: bold; font-display: swap; }
        :root { --neon-blue: #00d4ff; --neon-green: #00ff41; --neon-red: #ff4141; --bg-color: #020202; }
        body { background: var(--bg-color); color: #FFFFFF; font-family: 'Orbitron', sans-serif; margin: 0; height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; overflow: hidden; position: fixed; }
        #matrix-canvas { position: fixed; inset: 0; z-index: -1; opacity: 0.15; }
        .terminal { background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(0, 212, 255, 0.3); padding: 20px 40px; border-radius: 20px; width: 620px; height: 540px; box-shadow: 0 0 50px rgba(0, 212, 255, 0.15); position: relative; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        .main-title { font-size: 2.5em; letter-spacing: 8px; margin: 15px 0 5px 0; color: var(--neon-blue); text-shadow: 0 0 15px var(--neon-blue); }
        .sub-title { font-size: 0.7em; color: #555; margin-bottom: 15px; letter-spacing: 4px; font-weight: bold; }
        .master-btn { width: 140px; height: 140px; border-radius: 50%; border: 2px solid var(--neon-blue); background: transparent; color: #FFFFFF; font-family: 'Orbitron'; font-size: 1em; font-weight: bold; cursor: pointer; transition: 0.4s; margin: 10px 0; text-shadow: 0 0 10px var(--neon-blue); animation: scan 3s infinite linear; position: relative; }
        .master-btn:disabled { border-color: #333; color: #444; text-shadow: none; animation: none; cursor: not-allowed; }
        .dir-map { display: flex; flex-direction: row; justify-content: center; gap: 6px; margin: 15px 0; width: 100%; direction: ltr; }
        .node { flex: 1; height: 30px; background: rgba(255,255,255,0.02); border: 1px solid #222; border-radius: 4px; font-size: 0.5em; display: flex; align-items: center; justify-content: center; color: #444; transition: 0.5s; }
        .node.active { border-color: var(--neon-blue); color: #FFF; background: rgba(0,212,255,0.15); box-shadow: 0 0 10px var(--neon-blue); }
        .node.done { border-color: var(--neon-green); color: var(--neon-green); background: rgba(0,255,65,0.05); }
        #output { background: rgba(0,0,0,0.5); border-radius: 5px; padding: 10px; width: 95%; height: 40px; font-family: monospace; font-size: 10px; color: var(--neon-green); margin-top: 10px; display: flex; align-items: center; justify-content: center; letter-spacing: 1px; }
        #left-smart-report { position: fixed; left: 20px; top: 30px; bottom: 30px; width: auto; max-width: 450px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; z-index: 100; }
        .log-entry { background: rgba(0, 15, 25, 0.95); border-left: 4px solid var(--neon-blue); padding: 12px 20px; font-size: 0.75em; font-family: 'Orbitron', monospace; animation: slideIn 0.3s ease-out forwards; color: #FFF; box-shadow: 0 5px 15px rgba(0,0,0,0.5); backdrop-filter: blur(10px); border-radius: 2px; line-height: 1.4; text-transform: uppercase; letter-spacing: 1px; width: max-content; min-width: 250px; direction: ltr; text-align: left; white-space: nowrap; overflow: visible; }
        .log-entry.success { border-left-color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green); }
        .log-entry.info { border-left-color: var(--neon-blue); text-shadow: 0 0 8px var(--neon-blue); }
        #cyber-clock { position: absolute; top: 15px; right: 25px; font-size: 1.2em; color: var(--neon-blue); font-family: monospace; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0, 212, 255, 0.5); }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes scan { 0% { box-shadow: 0 0 5px var(--neon-blue); } 50% { box-shadow: 0 0 20px var(--neon-blue); } 100% { box-shadow: 0 0 5px var(--neon-blue); } }
        .option-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #111; width: 100%; }
        .palette-btn { background: #111; border: 1px solid #333; color: #777; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-family: 'Orbitron'; font-size: 0.6em; }
        .check-container { font-size: 9px; color: #555; display: flex; align-items: center; gap: 4px; }
        #lock-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .lock-input { background: #050505; border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 12px; text-align: center; font-family: 'Orbitron'; border-radius: 5px; width: 220px; margin-bottom: 15px; font-size: 1.2em; }
    </style>
</head>
<body onload="initApp()">
    <div id="lock-screen">
        <h2 style="letter-spacing: 8px; color: #FFF;">TERMINAL LOCKED</h2>
        <input type="password" id="passCode" class="lock-input" placeholder="PINCODE">
        <button class="palette-btn" style="color: var(--neon-blue); border-color: var(--neon-blue);" onclick="checkPass()">ACCESS SYSTEM</button>
    </div>
    <div id="cache-overlay" style="position:fixed; inset:0; background:#000; z-index:2000; display:none; align-items:center; justify-content:center; flex-direction:column;">
        <h3 style="color: var(--neon-blue); letter-spacing: 5px;">DOWNLOADING DATA...</h3>
        <div style="width: 300px; height: 4px; background: #111;"><div id="cache-progress" style="width: 0%; height: 100%; background: var(--neon-blue);"></div></div>
    </div>
    <canvas id="matrix-canvas"></canvas>
    <div id="left-smart-report"></div>
    <div class="terminal">
        <div id="cyber-clock">00:00:00.000</div>
        <h1 class="main-title">MALTA PRO</h1>
        <p class="sub-title">STABLE SYSTEM V2</p>
        <div class="dir-map">
            <div class="node" id="n_jail">WEBKIT</div>
            <div class="node" id="n1">KERNEL</div>
            <div class="node" id="n2">ROOT</div>
            <div class="node" id="n3">SYNC</div>
            <div class="node" id="n4">DONE</div>
        </div>
        <button id="startBtn" class="master-btn" onclick="launchPSFree()">EXECUTE</button>
        <div id="output">SYSTEM_STANDBY</div>
        <div id="smart-monitor" style="margin-top: 15px; font-size: 0.7em; display: flex; gap: 30px; color: #444;">
            <span>SAVES: <b id="copied-counter" style="color:var(--neon-green)">0</b></span>
            <span>STATUS: <b id="system-live-status" style="color:var(--neon-blue)">READY</b></span>
        </div>
        <div class="option-group">
            <button class="palette-btn" onclick="location.reload()">REBOOT</button>
            <button class="palette-btn" style="color: var(--neon-red)" onclick="exitBrowser()">EXIT</button>
            <div style="gap: 10px; display: flex; margin-right: 15px;">
                <label class="check-container"><input type="checkbox" id="autoStartToggle" checked onchange="saveSettings()"> START</label>
                <label class="check-container"><input type="checkbox" id="autoExitToggle" checked onchange="saveSettings()"> EXIT</label>
                <label class="check-container"><input type="checkbox" id="killAppsToggle" checked onchange="saveSettings()"> KILL</label>
            </div>
        </div>
    </div>

<script>
    const ftpBase = "http://127.0.0.1:2121";
    const sourceDir = "/data/malta/game_saves";
    let currentUser = "10000000"; 
    let matrixColor = "#00d4ff";

    function updateClock() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, '0');
        const m = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        const ms = String(now.getMilliseconds()).padStart(3, '0');
        document.getElementById('cyber-clock').innerText = `${h}:${m}:${s}.${ms}`;
        requestAnimationFrame(updateClock);
    }

    function addLog(msg, type='info') {
        const container = document.getElementById('left-smart-report');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerHTML = `<div style="font-size:0.6em; opacity:0.5; margin-bottom:2px; text-align:left;">> SYSTEM_LOG</div>${msg}`;
        container.prepend(entry);
        if(container.children.length > 8) container.lastChild.remove();
    }

    function checkPass() {
        if(document.getElementById('passCode').value === "2580") {
            localStorage.setItem('malta_unlocked', 'true');
            document.getElementById('lock-screen').style.display = 'none';
            addLog("ACCESS GRANTED", "success");
            if(document.getElementById('autoStartToggle').checked) launchPSFree();
        } else { addLog("ACCESS DENIED", "info"); alert("DENIED"); }
    }

    function saveSettings() {
        localStorage.setItem('malta_auto_exit', document.getElementById('autoExitToggle').checked);
        localStorage.setItem('malta_auto_start', document.getElementById('autoStartToggle').checked);
        localStorage.setItem('malta_kill_apps', document.getElementById('killAppsToggle').checked);
    }

    async function launchPSFree() {
        const out = document.getElementById('output');
        const btn = document.getElementById('startBtn');
        btn.disabled = true; btn.innerText = "WAITING...";
        addLog("INIT EXPLOIT CHAIN...");
        try {
            if(document.getElementById('killAppsToggle').checked) {
                addLog("CLEANING MEMORY...");
                await fetch(`${ftpBase}/process?action=killall`).catch(()=>{});
            }
            let checkHen = await fetch(`${ftpBase}/list?path=/data`).catch(()=>({ok:false}));
            if(checkHen.ok) {
                out.innerHTML = `HEN_ACTIVE`;
                addLog("HEN DETECTED: OK", "success");
                ['n_jail','n1','n2'].forEach(id => document.getElementById(id).className = 'node done');
                startMaltaSequence(); return;
            }
            out.innerHTML = `EXPLOITING...`;
            addLog("RUNNING WEBKIT...");
            if (typeof window.psfree === "undefined") {
                const { psfree } = await import('./psfree.mjs');
                window.psfree = psfree;
            }
            await window.psfree();
            document.getElementById('n_jail').className = 'node done';
            addLog("INJECTING GOLDHEN...");
            const response = await fetch('goldhen.bin');
            const pld = await response.arrayBuffer();
            await window.psfree_inject_payload(pld);
            document.getElementById('n1').className = 'node done';
            document.getElementById('n2').className = 'node done';
            out.innerHTML = `ROOTED!`;
            addLog("SYSTEM ROOTED", "success");
            startMaltaSequence();
        } catch (e) {
            out.innerHTML = `FAILED`;
            addLog("EXPLOIT FAILED", "info");
            btn.disabled = false; btn.innerText = "RETRY";
        }
    }

    async function startMaltaSequence() {
        document.getElementById('system-live-status').innerText = "SYNC";
        document.getElementById('n3').className = 'node active';
        addLog("LOCATING FILES...");
        const users = ["10000000", "10000001", "10000002", "10000003"];
        for(let u of users) {
            try {
                let res = await fetch(`${ftpBase}/list?path=/user/home/${u}`);
                if(res.ok) {
                    let files = await res.json();
                    if(files.includes("malta1.txt")) { currentUser = u; break; }
                }
            } catch(e) {}
        }
        addLog(`USER ID: ${currentUser}`, "success");
        await showReport();
        document.getElementById('n3').className = 'node done';
        document.getElementById('n4').className = 'node done';
        document.getElementById('system-live-status').innerText = "DONE";
        matrixColor = "#00ff41";
        document.getElementById('startBtn').innerText = "FINISH";
        addLog("SYNC COMPLETE", "success");
        if(document.getElementById('autoExitToggle').checked) setTimeout(exitBrowser, 2000);
    }

    async function showReport() {
        const counterEl = document.getElementById('copied-counter');
        try {
            const listRes = await fetch(`${ftpBase}/list?path=${sourceDir}`);
            const items = await listRes.json();
            let count = 0;
            for (let item of items) {
                addLog(`COPYING: ${item.substring(0,25)}...`);
                await fetch(`${ftpBase}/delete?path=/user/home/${currentUser}/savedata/${item}`).catch(()=>{});
                const copyRes = await fetch(`${ftpBase}/copy?from=${sourceDir}/${item}&to=/user/home/${currentUser}/savedata/${item}`);
                if(copyRes.ok) { 
                    count++; 
                    counterEl.innerText = count;
                    let p = count / items.length;
                    matrixColor = `rgb(${Math.floor(0*(1-p) + 0*p)}, ${Math.floor(212*(1-p) + 255*p)}, ${Math.floor(255*(1-p) + 65*p)})`;
                }
                await new Promise(r => setTimeout(r, 80));
            }
        } catch(e) { addLog("SYNC ERROR", "info"); }
    }

    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズヅブプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
    const alphabet = katakana + 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const fontSize = 16;
    const columns = canvas.width / fontSize;
    const rainDrops = Array.from({ length: columns }).fill(1);
    function drawMatrix() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = matrixColor; 
        ctx.font = fontSize + 'px monospace';
        for (let i = 0; i < rainDrops.length; i++) {
            const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
            ctx.fillText(text, i * fontSize, rainDrops[i] * fontSize);
            if (rainDrops[i] * fontSize > canvas.height && Math.random() > 0.975) { rainDrops[i] = 0; }
            rainDrops[i]++;
        }
    }
    setInterval(drawMatrix, 50);

    function initApp() {
        if(localStorage.getItem('malta_unlocked') === 'true') document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('autoExitToggle').checked = localStorage.getItem('malta_auto_exit') !== 'false';
        document.getElementById('autoStartToggle').checked = localStorage.getItem('malta_auto_start') !== 'false';
        document.getElementById('killAppsToggle').checked = localStorage.getItem('malta_kill_apps') !== 'false';
        updateClock();
        if (window.applicationCache) {
            window.applicationCache.addEventListener('onprogress', (e) => {
                document.getElementById('cache-overlay').style.display = 'flex';
                document.getElementById('cache-progress').style.width = Math.round((e.loaded / e.total) * 100) + '%';
            });
        }
    }
    function exitBrowser() { window.location.href = "about:blank"; }
</script>
</body>
</html>
